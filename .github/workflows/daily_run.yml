name: Daily YouTube AI Filter Run

on:
  schedule:
    - cron: '30 15 * * *'  # 9:00 PM IST (15:30 UTC)
  workflow_dispatch:

jobs:
  run-script:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip python3-dev curl
          # Install deno for yt-dlp JavaScript runtime
          curl -fsSL https://deno.land/install.sh | sh
          export DENO_INSTALL="/home/runner/.deno"
          export PATH="$DENO_INSTALL/bin:$PATH"
          echo "DENO_INSTALL=$DENO_INSTALL" >> $GITHUB_ENV
          echo "$DENO_INSTALL/bin" >> $GITHUB_PATH

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install feedparser google-genai requests
          pip install yt-dlp
          
          # Verify installations
          echo "=== Checking installations ==="
          python -c "import feedparser; print('✓ feedparser')"
          python -c "import google.genai; print('✓ google-genai')"
          python -c "import requests; print('✓ requests')"
          yt-dlp --version && echo "✓ yt-dlp"
          deno --version && echo "✓ deno"

      - name: Run the script
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # Ensure deno is in PATH
          export DENO_INSTALL="/home/runner/.deno"
          export PATH="$DENO_INSTALL/bin:$PATH"
          python daily_filter.py
