name: Daily YouTube AI Filter Run

on:
  schedule:
    - cron: '30 15 * * *'  # 9:00 PM IST (15:30 UTC)
  workflow_dispatch:

jobs:
  run-script:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system dependencies for yt-dlp
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip python3-dev build-essential
          sudo apt-get install -y ffmpeg  # Optional but useful

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install feedparser google-genai requests
          
          # Install youtube-transcript-api
          pip install youtube-transcript-api
          
          # Install yt-dlp with proper dependencies
          pip install yt-dlp[default]
          
          # Install Node.js (JavaScript runtime for yt-dlp)
          curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
          sudo apt-get install -y nodejs
          
          # Verify installations
          echo "=== Checking installations ==="
          python -c "import feedparser; print('✓ feedparser')"
          python -c "import google.genai; print('✓ google-genai')"
          python -c "import requests; print('✓ requests')"
          
          # Check yt-dlp
          yt-dlp --version && echo "✓ yt-dlp"
          
          # Check Node.js
          node --version && echo "✓ Node.js"
          
          # Test yt-dlp with a simple command
          echo "Testing yt-dlp..."
          yt-dlp --skip-download --get-title "https://www.youtube.com/watch?v=dQw4w9WgXcQ" && echo "✓ yt-dlp works"

      - name: Run the script
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          python daily_filter.py
